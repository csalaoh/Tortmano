<!DOCTYPE html>
<html lang="hu">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport"
            content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
        <title>T√∂rtman√≥ Teszt - Felm√©r≈ë</title>
        <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #e0f7fa;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            color: #333;
            -webkit-overflow-scrolling: touch; 
        }
        h1 { color: #006064; margin-bottom: 5px; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); }
        
        .container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            text-align: center;
            max-width: 900px;
            width: 100%;
        }

        /* --- K√âPERNY≈êK --- */
       #start-screen {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        text-align: center;
    }
        #game-screen { display: none; }
        #report-screen { display: none; padding: 20px; } 

        #name-input { font-size: 1.5em; padding: 10px; border-radius: 10px; border: 2px solid #00bcd4; width: 80%; margin-bottom: 20px; text-align: center; }

        /* --- K√ñZ√ñS ST√çLUSOK --- */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #006064;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: bold;
            flex-wrap: wrap; 
        }
        .student-name-display { color: #80deea; font-size: 1.1em; }
        
        .problem-container { 
            margin: 20px 0; display: flex; align-items: center; justify-content: center; flex-wrap: wrap; min-height: 100px; background-color: #fff;
            padding: 20px; border-radius: 10px; border: 2px solid #b2ebf2; font-size: 1.6em;
        }
        .fraction { display: inline-flex; flex-direction: column; align-items: center; vertical-align: middle; margin: 0 4px; }
        .numerator { border-bottom: 2px solid #333; padding: 0 4px; display: block; text-align: center; width: 100%; }
        .denominator { padding: 0 4px; display: block; text-align: center; width: 100%; }
        .operator { margin: 0 10px; font-weight: bold; color: #00838f; }
        .bracket { font-size: 1.4em; color: #d84315; font-weight: 300; margin: 0 2px; }
        .whole-number { font-size: 1.2em; font-weight: bold; margin: 0 5px; }

        .answer-section { 
            background-color: #fafafa; border: 2px dashed #0288d1; border-radius: 12px; padding: 20px; margin-bottom: 20px; display: flex; flex-direction: column; align-items: center;
        }
        .input-row { display: flex; align-items: center; gap: 15px; margin-top: 10px; }
        .whole-input { width: 60px; height: 60px; font-size: 1.6em; text-align: center; border: 2px solid #ff9800; border-radius: 8px; }
        .fraction-col { display: flex; flex-direction: column; gap: 4px; align-items: center; }
        .small-input { width: 60px; height: 45px; font-size: 1.3em; text-align: center; border: 2px solid #03a9f4; border-radius: 8px; }
        .fraction-line { width: 60px; height: 3px; background: #333; }

        /* --- GOMBOK --- */
        button { 
            border: none; padding: 12px 25px; border-radius: 8px; font-size: 1.1em; font-weight: bold; cursor: pointer; transition: all 0.2s; margin: 5px; 
            -webkit-appearance: none; 
            touch-action: manipulation; 
        }
        .btn-start { background-color: #009688; color: white; width: 100%; max-width: 300px; font-size: 1.3em; margin-top: 20px;}
        .btn-check { background-color: #00bcd4; color: white; } 
        
        .btn-send { background-color: #2196F3; color: white; width: 100%; margin-top:15px; font-size: 1.2em; display: none; }
        .loading-spinner { display: inline-block; width: 20px; height: 20px; border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top-color: #fff; animation: spin 1s ease-in-out infinite; margin-right: 10px; vertical-align: middle; }
        @keyframes spin { to { transform: rotate(360deg); } }

        #report-output { width: 100%; font-family: monospace; padding: 15px; border: 2px solid #006064; border-radius: 8px; resize: none; box-sizing: border-box; }
        .report-buttons button { padding: 15px 30px; font-size: 1.2em; }
        
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        
        #status-message { margin-top: 15px; font-weight: bold; min-height: 1.5em; }
        
        .warning-box {
            background-color: #fff8e1;
            border: 3px solid #f57f17;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 25px;
            text-align: left;
            font-weight: bold;
            color: #3e2723;
        }

        /* --- EREDM√âNY KIEMEL√âS ST√çLUSOK --- */
        .summary-box {
            background: #e8f5e9;
            border: 4px solid #43a047;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .summary-score { 
            font-size: 1.3em; 
            color: #444; 
            margin-bottom: 15px; 
            border-bottom: 1px solid #c8e6c9;
            padding-bottom: 10px;
        }
        
        /* Itt t√∂rt√©nik a m√©ret be√°ll√≠t√°s */
        .grade-label {
            font-size: 1rem; 
            color: #666; 
            text-transform: uppercase; 
            letter-spacing: 2px;
            margin-bottom: 5px;
        }
        .grade-value {
            font-size: 5rem; /* Nagyon nagy sz√°m */
            font-weight: 900; 
            color: #2e7d32; 
            line-height: 1;
        }
    </style>
    </head>
    <body>

        <h1>ü¶ä T√∂rtman√≥ Teszt - Felm√©r≈ë</h1>

        <div class="container">

            <div id="start-screen">
                <h2>Szia! Hogy h√≠vnak?</h2>
                
                <div class="warning-box">
                    <h3>‚ùó Pontoz√°si Szab√°lyok ‚ùó</h3>
                    <p>Ez a teszt **16 feladatot** tartalmaz. Minden feladatn√°l hib√°tlan v√°lasz eset√©n j√°r a maxim√°lis pontsz√°m.</p>
                    <p>A maxim√°lis pontok: **Alap A/K (4p), Vegyes A/K (5p), M/O (4p), Z√°r√≥jeles (6p)**.</p>
                    <p>Pontlevon√°s j√°r:</p>
                    <ul>
                        <li>Ha az eredm√©ny nincs **egyszer≈±s√≠tve** (ha lehet): **-1 pont**.</li>
                        <li>Ha az eredm√©ny nincs **vegyes sz√°mm√°** alak√≠tva (ha lehet): **-1 pont**.</li>
                    </ul>
                </div>
                
                <form id="login-form" style="width: 100%; display: flex; flex-direction: column; align-items: center;">
                    <input type="text" id="name-input" placeholder="√çrd ide a neved..." required>
                    <button type="submit" class="btn-start">Teszt ind√≠t√°sa</button>
                </form>
            </div>

            <div id="game-screen">

                <div class="top-bar">
                    <div>
                        <span class="student-name-display" id="display-name">Tanul√≥</span> | 
                        <span id="progress-text">1 / 16. feladat</span>
                    </div>
                </div>

                <div class="problem-container" id="problem-box"></div>

                <div id="review-feedback" style="display:none; text-align: left; background-color: #e3f2fd; border: 2px solid #03a9f4; border-radius: 10px; padding: 15px; margin-bottom: 20px;">
                    <h3 style="color:#01579b; margin-top:0;">üìä Visszajelz√©s a feladatr√≥l</h3>
                    <p><strong>Felhaszn√°l√≥ V√°lasza:</strong> <span id="review-user-answer"></span></p>
                    <p><strong>Helyes Megold√°s:</strong> <span id="review-correct-answer" style="font-weight: bold; color: #009688;"></span></p>
                    <p><strong>Pontsz√°m:</strong> <span id="review-score-display" style="font-size: 1.1em; font-weight: bold;"></span></p>
                    <p><strong>R√©szletek:</strong> <span id="review-notes"></span></p>
                </div>

                <div class="answer-section" id="answer-input-section">
                    <div class="input-row">
                        <span style="font-size: 2em;">=</span>
                        <input type="number" id="inp-whole" class="whole-input" placeholder="E">
                        <div class="fraction-col">
                            <input type="number" id="inp-num" class="small-input" placeholder="Sz">
                            <div class="fraction-line"></div>
                            <input type="number" id="inp-denom" class="small-input" placeholder="N">
                        </div>
                    </div>
                </div>

                <button class="btn-check" onclick="submitAnswer()" id="submit-btn" style="width: 100%; max-width: 300px;">V√°lasz Bek√ºld√©se ‚û°Ô∏è</button>
                <button class="btn-check" onclick="continueToNext()" id="continue-btn" style="width: 100%; max-width: 300px; display: none; background-color: #8bc34a;">Tov√°bb a k√∂vetkez≈ëre ‚û°Ô∏è</button>

            </div>

            <div id="report-screen">
                <h2>üìä Felm√©r≈ë Eredm√©ny</h2>

                <div class="summary-box">
                    <div class="summary-score">
                        El√©rt pontsz√°m: <strong id="final-score"></strong> / <span id="final-max"></span> pont (<span id="final-percent"></span>%)
                    </div>
                    <div>
                        <div class="grade-label">√ârdemjegy</div>
                        <div class="grade-value" id="final-grade"></div>
                    </div>
                </div>

                <div id="status-message"></div>

                <button id="btn-send-data" class="btn-send"
                    onclick="sendReportToGoogle()">
                    üöÄ Eredm√©ny k√ºld√©se a Tan√°rnak
                </button>

                <p style="margin-top:20px; font-size:0.9em; color:#666;">
                    Ha a k√ºld√©s nem siker√ºlne, itt a biztons√°gi m√°solat:
                </p>
                <textarea id="report-output" readonly rows="10"></textarea>

                <div class="report-buttons">
                    <button onclick="copyReport()"
                        style="background-color:#555; color:white; font-size:0.9em;">M√°sol√°s
                        v√°g√≥lapra (Tartal√©k)</button>
                    <button onclick="window.location.reload()"
                        style="background-color:#ff9800; color:white;">√öjrakezd√©s</button>
                </div>
            </div>
        </div>

        <script>
        // ==========================================================
        // CONFIG: IDE M√ÅSOLD BE A KAPOTT GOOGLE SCRIPT LINKET!
        // ==========================================================
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbymo37p92s9saK9CX7QSr-heJFpsVuJ0xxuV3aCLDZdRr1nahmDwVr-gFJ9DI94uzH2lw/exec"; 
        // ==========================================================

        // --- TESZT √ÅLLAPOT V√ÅLTOZ√ìK ---
        let studentName = "";
        let startTime;
        let sessionLog = [];
        let currentProblemText = ""; 
        let currentSolution = null;
        let reportDataPackage = null;
        
        // --- TESZT SPECIFIKUS KONFIG ---
        let currentQuestionIndex = 0;
        
        // --- R√ñGZ√çTETT FELADATSOR (16 db) ---
        const PROBLEM_QUEUE = [
            { id: 1, type: 'AddSubSimple', ops: ['+'], count: 1, diff: '2', brackets: false, forceMixedInput: false, desc: 'T√∂rt + T√∂rt (1 m≈±v)' },
            { id: 2, type: 'AddSubSimple', ops: ['-'], count: 1, diff: '2', brackets: false, forceMixedInput: false, desc: 'T√∂rt - T√∂rt (1 m≈±v)' },
            { id: 3, type: 'AddSubSimple', ops: ['+', '-'], count: 2, diff: '2', brackets: false, forceMixedInput: false, desc: 'Vegyes (+/-) (2 m≈±v)' },
            { id: 4, type: 'AddSubSimple', ops: ['+', '-'], count: 2, diff: '2', brackets: false, forceMixedInput: false, desc: 'Vegyes (+/-) (2 m≈±v)' },
            
            { id: 5, type: 'AddSubMixed', ops: ['+'], count: 1, diff: '2', brackets: false, forceMixedInput: true, desc: 'Vegyes T√∂rt + Vegyes T√∂rt' },
            { id: 6, type: 'AddSubMixed', ops: ['-'], count: 1, diff: '2', brackets: false, forceMixedInput: true, desc: 'Vegyes T√∂rt - Vegyes T√∂rt' },
            
            { id: 7, type: 'MultDivInt', ops: ['*'], count: 1, diff: '2', brackets: false, forceInteger: true, desc: 'T√∂rt * Eg√©sz (1 m≈±v)' },
            { id: 8, type: 'MultDivInt', ops: ['/'], count: 1, diff: '2', brackets: false, forceInteger: true, desc: 'T√∂rt / Eg√©sz (1 m≈±v)' },

            { id: 9, type: 'MultDivSimple', ops: ['*'], count: 1, diff: '2', brackets: false, desc: 'T√∂rt * T√∂rt (1 m≈±v)' },
            { id: 10, type: 'MultDivSimple', ops: ['*'], count: 1, diff: '2', brackets: false, desc: 'T√∂rt * T√∂rt (1 m≈±v)' },
            { id: 11, type: 'MultDivSimple', ops: ['/'], count: 1, diff: '2', brackets: false, desc: 'T√∂rt : T√∂rt (1 m≈±v)' },
            { id: 12, type: 'MultDivSimple', ops: ['/'], count: 1, diff: '2', brackets: false, desc: 'T√∂rt : T√∂rt (1 m≈±v)' },
            
            // Z√°r√≥jeles feladatok (Az innerOp a bracketed op. Az outer op az ops[0])
            { id: 13, type: 'Brackets', ops: ['*'], count: 2, brackets: true, innerOp: ['+'], diff: '2', desc: 'T√∂rt * (√ñsszead√°s)' },
            { id: 14, type: 'Brackets', ops: ['*'], count: 2, brackets: true, innerOp: ['-'], diff: '2', desc: 'T√∂rt * (Kivon√°s)' },
            { id: 15, type: 'Brackets', ops: ['/'], count: 2, brackets: true, innerOp: ['+'], diff: '2', desc: 'T√∂rt : (√ñsszead√°s)' },
            { id: 16, type: 'Brackets', ops: ['/'], count: 2, brackets: true, innerOp: ['-'], diff: '2', desc: 'T√∂rt : (Kivon√°s)' }
        ];
        const TOTAL_QUESTIONS = PROBLEM_QUEUE.length;


        // --- MATEMATIKA ---
        function gcd(a, b) { return b === 0 ? a : gcd(b, a % b); }

        class Fraction {
            constructor(n, d) {
                if (d < 0) { n = -n; d = -d; }
                this.n = parseInt(n);
                this.d = parseInt(d);
            }
            simplify() {
                const common = gcd(Math.abs(this.n), this.d);
                return new Fraction(this.n / common, this.d / common);
            }
            add(f) { return new Fraction(this.n * f.d + f.n * this.d, this.d * f.d).simplify(); }
            sub(f) { return new Fraction(this.n * f.d - f.n * this.d, this.d * f.d).simplify(); }
            mult(f) { return new Fraction(this.n * f.n, this.d * f.d).simplify(); }
            div(f) { 
                if (f.n === 0) { return new Fraction(0, 1); }
                if (f.d === 0) { return new Fraction(0, 1); } 
                return new Fraction(this.n * f.d, this.d * f.n).simplify(); 
            }
            isInteger() { return this.d === 1; }
            toString() { return this.d === 1 ? `${this.n}` : `${this.n}/${this.d}`; }
            isSimplifiable() { return gcd(Math.abs(this.n), this.d) > 1; }
            toMixed() {
                if (Math.abs(this.n) < this.d || this.d === 0) return { w: 0, n: this.n, d: this.d };
                const w = Math.floor(this.n / this.d);
                const n = Math.abs(this.n) % this.d;
                return { w: w, n: n, d: this.d };
            }
        }

        // --- BEL√âP√âS ---
        function enterGame() {
            const nameInput = document.getElementById('name-input').value.trim();
            if(nameInput === "") {
                alert("K√©rlek √≠rd be a neved!");
                return;
            }
            if (document.activeElement) { document.activeElement.blur(); }

            studentName = nameInput;
            startTime = new Date();
            
            document.getElementById('display-name').innerText = studentName;
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('game-screen').style.display = 'block';
            document.getElementById('report-screen').style.display = 'none';
            
            currentQuestionIndex = 0;
            sessionLog = [];
            generateProblem(); 
        }

        // --- SEG√âDF√úGGV√âNYEK ---
        function getSettingsDescription(problem) {
            let desc = problem.desc;
            if (problem.brackets) desc += " (Z√°r√≥jeles)";
            if (problem.count > 1) desc += ` (${problem.count} m≈±v)`;
            return desc;
        }

        // SZ√ÅMGENER√ÅL√ÅS (JAV√çTOTT: 0 √©s 1 kiz√°rva)
        function getRandomFraction(diff, forceInteger = false, forceMixed = false) {
            let maxNum = diff === '1' ? 5 : (diff === '2' ? 12 : 20);
            const denoms = diff === '1' ? [2,3,4,5,10] : [2,3,4,5,6,8,9,10,12,15];
            
            let n, d;
            
            // 1. Eg√©sz sz√°m gener√°l√°sa (T√∂rt * Eg√©sz-hez)
            if (forceInteger) {
                d = 1;
                // n >= 2 kell legyen (hogy ne legyen 1 a szorz√≥/oszt√≥)
                n = Math.floor(Math.random() * (maxNum - 1)) + 2; 
                return new Fraction(n, 1);
            }
            
            // 2. Norm√°l t√∂rt gener√°l√°sa
            d = denoms[Math.floor(Math.random() * denoms.length)];
            
            if (forceMixed) {
                // Vegyes sz√°mn√°l n > d kell, hogy legyen eg√©sz r√©sz
                do {
                    n = Math.floor(Math.random() * (d * 3)) + 1;
                } while (n === 0 || n <= d); 
                // n<=d kiz√°rja az 1-et is (d/d=1), √©s azt is, hogy ne legyen eg√©sz r√©sze
            } else {
                // Sima t√∂rtn√©l
                do {
                    n = Math.floor(Math.random() * (d * 2)) + 1; 
                } while (n === 0 || n === d); // n=d (√©rt√©k=1) nem lehet
            }

            return new Fraction(n, d);
        }
        
        // --- PONTOZ√ÅS LOGIKA ---
        function calculatePoints(userVal, correctVal, problemType, wInput, nInput, dInput) {
            let score = 0;
            let maxPoints = 0;
            let note = "";

            if (problemType.includes('AddSubSimple')) { maxPoints = 4; }
            else if (problemType.includes('AddSubMixed')) { maxPoints = 5; }
            else if (problemType.includes('MultDiv')) { maxPoints = 4; }
            else if (problemType === 'Brackets') { maxPoints = 6; }
            else { maxPoints = 4; }

            const isMathCorrect = (userVal.n * correctVal.d === correctVal.n * userVal.d);
            
            if (!isMathCorrect) {
                note = "Helytelen matematikai √©rt√©k. (0 pont)";
                return { score: 0, max: maxPoints, note: note };
            }

            score = maxPoints;
            
            // Egyszer≈±s√≠t√©s ellen≈ërz√©se
            const isUserSimplified = userVal.n === userVal.simplify().n;
            
            if (!isUserSimplified) {
                score -= 1;
                note += " Hi√°nyzik az egyszer≈±s√≠t√©s (-1 pont).";
            } else {
                note += " Egyszer≈±s√≠t√©s OK. ";
            }
            
            // Vegyes sz√°m alak√≠t√°s ellen≈ërz√©se
            const needsMixed = Math.abs(correctVal.n) > correctVal.d && correctVal.d !== 1;
            const isUserMixed = wInput !== 0 && Math.abs(nInput) < dInput && dInput !== 0; 

            if (needsMixed) {
                if (!isUserMixed) {
                    score -= 1;
                    note += " Hi√°nyzik a vegyes sz√°mm√° alak√≠t√°s (-1 pont).";
                } else {
                    note += " Vegyes sz√°m OK. ";
                }
            } else {
                 note += " Vegyes sz√°m nem sz√ºks√©ges. ";
            }
            
            if (score < 0) score = 0;

            return { score: score, max: maxPoints, note: note.trim() };
        }


        // --- FELADAT GENER√ÅL√ÅSA ---
        function generateProblem() {
            currentQuestionIndex++;
            const problem = PROBLEM_QUEUE[currentQuestionIndex - 1];

            document.getElementById('progress-text').innerText = `${currentQuestionIndex} / ${TOTAL_QUESTIONS}. feladat`;
            document.getElementById('inp-whole').value = '';
            document.getElementById('inp-num').value = '';
            document.getElementById('inp-denom').value = '';

            // Reset UI
            document.getElementById('review-feedback').style.display = 'none';
            document.getElementById('continue-btn').style.display = 'none';
            document.getElementById('answer-input-section').style.display = 'flex';
            document.getElementById('submit-btn').style.display = 'block';

            const btn = document.getElementById('submit-btn');
            if(currentQuestionIndex === TOTAL_QUESTIONS) {
                btn.innerText = "Teszt Befejez√©se √©s Eredm√©nyez√©s ‚úÖ";
                btn.style.backgroundColor = "#d32f2f"; 
            } else {
                btn.innerText = "V√°lasz Bek√ºld√©se ‚û°Ô∏è";
                btn.style.backgroundColor = "#00bcd4";
            }
            
            const diff = problem.diff;
            let operators = [...problem.ops];
            let opCount = problem.count;
            let numbers = [];
            
            if (problem.forceMixedInput) {
                numbers.push(getRandomFraction(diff, false, true)); 
                numbers.push(getRandomFraction(diff, false, true)); 
            } 
            else if (problem.forceInteger) {
                numbers.push(getRandomFraction(diff, false, false)); 
                numbers.push(getRandomFraction(diff, true, false)); 
            } 
            else if (problem.brackets) {
                numbers.push(getRandomFraction(diff, false, false)); // K√ºls≈ë sz√°m
                
                let f1 = getRandomFraction(diff, false, false);
                let f2 = getRandomFraction(diff, false, false);

                // Biztos√≠tjuk, hogy a z√°r√≥jelben ne legyen negat√≠v eredm√©ny, ha kivon√°s van
                if (problem.innerOp && problem.innerOp[0] === '-' && f1.n * f2.d < f2.n * f1.d) {
                    [f1, f2] = [f2, f1]; 
                }
                
                numbers.push(f1);
                numbers.push(f2);
                operators = [problem.ops[0], problem.innerOp[0]]; 
            }
            else {
                for(let i=0; i<=opCount; i++) {
                    numbers.push(getRandomFraction(diff, false, false));
                }
            }

            // HTML Gener√°l√°s
            let html = "";
            let textLog = ""; 
            const displayOps = { '+': '+', '-': '-', '*': '¬∑', '/': ':' };

            for(let i=0; i<numbers.length; i++) {
                let currentNum = numbers[i];
                let fractionHtml = "";
                let fractionText = "";
                
                if (problem.forceMixedInput && !currentNum.isInteger() && currentNum.n > currentNum.d) {
                    const mixed = currentNum.toMixed();
                    fractionHtml = `<span class="whole-number">${mixed.w}</span>`;
                    fractionText = `${mixed.w}`;
                    if (mixed.n !== 0) {
                        fractionHtml += `<div class="fraction"><span class="numerator">${mixed.n}</span><span class="denominator">${mixed.d}</span></div>`;
                        fractionText += ` ${mixed.n}/${mixed.d}`;
                    }
                } else if (currentNum.isInteger()) {
                    fractionHtml = `<span class="whole-number">${currentNum.n}</span>`;
                    fractionText = `${currentNum.n}`;
                } else {
                    fractionHtml = `<div class="fraction"><span class="numerator">${currentNum.n}</span><span class="denominator">${currentNum.d}</span></div>`;
                    fractionText = `${currentNum.n}/${currentNum.d}`;
                }

                if (problem.brackets && i === 1) { 
                    html += `<span class="bracket">(</span>`; 
                    textLog += "("; 
                }

                html += fractionHtml;
                textLog += fractionText;
                
                if (problem.brackets && i === 2) { 
                    html += `<span class="bracket">)</span>`; 
                    textLog += ")"; 
                }

                if (i < numbers.length - 1) {
                    let opSymbol = "";
                    
                    if (problem.brackets) {
                        if (i === 0) opSymbol = displayOps[operators[0]];
                        if (i === 1) opSymbol = displayOps[operators[1]];
                    } else {
                        if (i < operators.length) opSymbol = displayOps[operators[i]];
                    }

                    if (opSymbol) {
                        html += `<span class="operator">${opSymbol}</span>`;
                        textLog += ` ${opSymbol} `;
                    }
                }
            }

            document.getElementById('problem-box').innerHTML = html;
            currentProblemText = textLog;

            // Sz√°mol√°s
            let workNums = [...numbers];
            let workOps = [...operators];

            const performOp = (f1, f2, op) => {
                switch(op) {
                    case '+': return f1.add(f2);
                    case '-': return f1.sub(f2);
                    case '*': return f1.mult(f2);
                    case '/': return f1.div(f2);
                    default: return f1;
                }
            };
            
            if (problem.brackets) {
                let f1 = workNums[1];
                let f2 = workNums[2];
                let op = workOps[1]; 
                let res = performOp(f1, f2, op);
                workNums.splice(1, 2, res); 
                workOps.splice(1, 1);
            }

            let k = 0;
            while (k < workOps.length) {
                if (workOps[k] === '*' || workOps[k] === '/') {
                    let f1 = workNums[k];
                    let f2 = workNums[k+1];
                    let op = workOps[k];
                    let res = performOp(f1, f2, op);
                    workNums.splice(k, 2, res);
                    workOps.splice(k, 1);
                } else { k++; }
            }

            while (workOps.length > 0) {
                let f1 = workNums[0];
                let f2 = workNums[1];
                let op = workOps[0];
                let res = performOp(f1, f2, op);
                workNums.splice(0, 2, res);
                workOps.shift();
            }

            currentSolution = workNums[0];
        }
        
        // --- VISSZAJELZ√âS ---
        function showReview(logEntry) {
            const reviewBox = document.getElementById('review-feedback');
            const correctSolutionMixed = logEntry.correctAnswer;
            
            document.getElementById('answer-input-section').style.display = 'none';
            document.getElementById('submit-btn').style.display = 'none';
            document.getElementById('continue-btn').style.display = 'block';
            reviewBox.style.display = 'block';

            document.getElementById('review-user-answer').innerText = logEntry.userAnswer;
            document.getElementById('review-correct-answer').innerText = correctSolutionMixed;
            document.getElementById('review-score-display').innerHTML = `${logEntry.score} / ${logEntry.maxScore} pont (${logEntry.isCorrect ? '<span style="color: green;">Helyes forma</span>' : '<span style="color: red;">Hib√°s forma</span>'})`;
            document.getElementById('review-notes').innerText = logEntry.note;

            if (logEntry.problemIndex === TOTAL_QUESTIONS) {
                 document.getElementById('continue-btn').innerText = "Teszt Befejez√©se √©s Eredm√©nyez√©s ‚úÖ";
            }
        }

        function continueToNext() {
            if (currentQuestionIndex >= TOTAL_QUESTIONS) {
                finishSession();
            } else {
                generateProblem();
            }
        }

        // --- V√ÅLASZ BEK√úLD√âSE ---
        function submitAnswer() {
            const problem = PROBLEM_QUEUE[currentQuestionIndex - 1];

            let w = parseInt(document.getElementById('inp-whole').value) || 0;
            let n = parseInt(document.getElementById('inp-num').value) || 0;
            let dInput = document.getElementById('inp-denom').value;
            let d = parseInt(dInput) || 1;

            if (dInput === '') {
                if (n !== 0) {
                    alert("K√©rlek adj meg nevez≈ët, ha t√∂rtet √≠rt√°l be!");
                    return;
                }
            } else if (dInput == 0) {
                alert("A nevez≈ë nem lehet nulla!");
                return;
            }

            let totalNum = w * d + n;
            const userValRaw = new Fraction(totalNum, d);
            const correct = currentSolution;

            const scoringResult = calculatePoints(userValRaw, correct, problem.type, w, n, d);
            
            let userText = (w !== 0 && n === 0) ? `${w}` : (w !== 0 ? `${w} ${n}/${d}` : `${n}/${d}`);
            if(n===0 && w===0) userText = "0";

            let logEntry = {
                problemIndex: currentQuestionIndex,
                problemType: problem.type,
                problem: currentProblemText,
                userAnswer: userText,
                correctAnswer: correct.toMixed().w !== 0 ? `${correct.toMixed().w} ${correct.toMixed().n}/${correct.toMixed().d}` : correct.toString(),
                isCorrect: scoringResult.score === scoringResult.max, 
                score: scoringResult.score,
                maxScore: scoringResult.max,
                note: scoringResult.note,
                settingsDesc: getSettingsDescription(problem)
            };
            sessionLog.push(logEntry);

            showReview(logEntry);
        }

        // --- RIPORT √âS K√úLD√âS (OSZT√ÅLYZ√ÅSSAL) ---
        function finishSession() {
            const endTime = new Date();
            const timeDiffMs = endTime - startTime;
            const timeDiffMin = Math.round(timeDiffMs / 1000 / 60); 
            
            let totalScore = sessionLog.reduce((sum, log) => sum + log.score, 0);
            let totalMaxScore = sessionLog.reduce((sum, log) => sum + log.maxScore, 0);
            let scorePercent = totalMaxScore > 0 ? Math.round((totalScore / totalMaxScore) * 100) : 0;
            
            // √ârdemjegy sz√°m√≠t√°sa
            let grade = 1;
            if (scorePercent >= 85) grade = 5;
            else if (scorePercent >= 70) grade = 4;
            else if (scorePercent >= 55) grade = 3;
            else if (scorePercent >= 40) grade = 2;
            
            // UI Friss√≠t√©s
            document.getElementById('game-screen').style.display = 'none';
            document.getElementById('report-screen').style.display = 'block';
            
            document.getElementById('final-score').innerText = totalScore;
            document.getElementById('final-max').innerText = totalMaxScore;
            document.getElementById('final-percent').innerText = scorePercent;
            document.getElementById('final-grade').innerText = grade; // Csak a sz√°m

            // Riport sz√∂veg
            const uniqueSettings = ["R√∂gz√≠tett 16 feladatsor"];
            let reportText = `T√ñRTMAN√ì TESZT JELENT√âS - ${studentName}\n`;
            reportText += `--------------------------------\n`;
            reportText += `√âRDEMJEGY: ${grade}\n`;
            reportText += `Eredm√©ny: ${scorePercent}% (${totalScore}/${totalMaxScore} pont)\n`;
            reportText += `Id≈ë: ${timeDiffMin} perc\n`;
            reportText += `--------------------------------\n\n`;
            reportText += `R√©szletek:\n`;
            sessionLog.forEach((log, index) => {
                let status = log.isCorrect ? "‚úÖ T√ñK√âLETES" : "‚ö†Ô∏è HIBA";
                reportText += `${index + 1}. ${status} (${log.score}/${log.maxScore} pont)\n`;
                reportText += `   > Feladat: ${log.problem} = ${log.userAnswer}\n`;
                reportText += `   > Pontoz√°s: ${log.note}\n`;
                if (log.score < log.maxScore) reportText += `   > Helyes forma: ${log.correctAnswer}\n`;
            });
            
            document.getElementById('report-output').value = reportText;

            reportDataPackage = {
                name: studentName,
                grade: grade, // √öj mez≈ë
                score: scorePercent,
                totalScore: totalScore,
                totalMaxScore: totalMaxScore,
                time: timeDiffMin,
                settings: uniqueSettings.join(', '),
                log: reportText
            };

            const btnSend = document.getElementById('btn-send-data');
            btnSend.style.display = 'block';
            
            if(GOOGLE_SCRIPT_URL.includes("IDE_MASOLD_BE_A_GOOGLE_SCRIPT_LINKET") || GOOGLE_SCRIPT_URL === "") {
                document.getElementById('status-message').innerHTML = "‚ö†Ô∏è Nincs be√°ll√≠tva a tan√°ri link! Haszn√°ld a m√°sol√°st.";
                document.getElementById('status-message').style.color = "red";
                btnSend.style.display = 'none';
            }
        }

        function sendReportToGoogle() {
            const btn = document.getElementById('btn-send-data');
            const statusDiv = document.getElementById('status-message');
            
            btn.disabled = true;
            btn.innerHTML = '<span class="loading-spinner"></span> K√ºld√©s folyamatban...';
            statusDiv.innerText = "";

            fetch(GOOGLE_SCRIPT_URL, {
                method: "POST",
                mode: "no-cors", 
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(reportDataPackage)
            })
            .then(response => {
                statusDiv.innerHTML = "‚úÖ Sikeresen elk√ºldve! K√∂sz√∂n√∂m a munk√°t.";
                statusDiv.style.color = "green";
                btn.style.display = 'none'; 
            })
            .catch(error => {
                console.error("Hiba:", error);
                statusDiv.innerHTML = "‚ùå Hiba t√∂rt√©nt a k√ºld√©skor. K√©rlek m√°sold ki a lenti sz√∂veget √©s k√ºldd el!";
                statusDiv.style.color = "red";
                btn.innerHTML = "√öjrapr√≥b√°lkoz√°s";
                btn.disabled = false;
            });
        }
        
        function copyReport() {
            const reportOutput = document.getElementById('report-output');
            reportOutput.select();
            reportOutput.setSelectionRange(0, 99999);
            document.execCommand("copy");
            alert("‚úÖ A jelent√©s m√°solva!");
        }

        window.onload = function() {
            document.getElementById('start-screen').style.display = 'flex';
            document.getElementById('game-screen').style.display = 'none';
            document.getElementById('report-screen').style.display = 'none';

            const loginForm = document.getElementById('login-form');
            if(loginForm) {
                loginForm.addEventListener('submit', function(e) {
                    e.preventDefault(); 
                    enterGame();
                });
            }
        };
    </script>
    </body>
</html>